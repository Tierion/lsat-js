<!DOCTYPE html><html class="default"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>LSAT-JS</title><meta name="description" content="Documentation for LSAT-JS"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.body.classList.add(localStorage.getItem("tsd-theme") || "os")</script><header><div class="tsd-page-toolbar"><div class="container"><div class="table-wrap"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget search no-caption">Search</label><input type="text" id="tsd-search-field"/></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">LSAT-JS</a></div><div class="table-cell" id="tsd-widgets"><div id="tsd-filter"><a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a><div class="tsd-filter-group"><div class="tsd-select" id="tsd-filter-visibility"><span class="tsd-select-label">All</span><ul class="tsd-select-list"><li data-value="public">Public</li><li data-value="protected">Public/Protected</li><li data-value="private" class="selected">All</li></ul></div> <input type="checkbox" id="tsd-filter-inherited" checked/><label class="tsd-widget" for="tsd-filter-inherited">Inherited</label><input type="checkbox" id="tsd-filter-externals" checked/><label class="tsd-widget" for="tsd-filter-externals">Externals</label></div></div><a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a></div></div></div></div><div class="tsd-page-title"><div class="container"><h1>LSAT-JS</h1></div></div></header><div class="container container-main"><div class="row"><div class="col-8 col-content"><div class="tsd-panel tsd-typography"><p><a href="https://github.com/prettier/prettier"><img src="https://img.shields.io/badge/code_style-prettier-ff69b4.svg?style=flat-square" alt="code style: prettier"></a>
<a href="https://travis-ci.com/Tierion/lsat-js"><img src="https://travis-ci.com/Tierion/lsat-js.svg?branch=master" alt="Build Status"></a>
<a href="https://coveralls.io/github/Tierion/lsat-js"><img src="https://coveralls.io/repos/github/Tierion/lsat-js/badge.svg" alt="Coverage Status"></a></p>

<a href="#lsat-js" id="lsat-js" style="color: inherit; text-decoration: none;">
  <h1>LSAT-JS</h1>
</a>
<p><code>lsat-js</code> is a suite of tools for working with LSATs in Nodejs and Typescript.</p>
<p>An LSAT, or Lightning Service Authentication Token, is a &quot;Lightning native macaroon based bearer
API credential&quot; <a href="https://docs.google.com/presentation/d/1QSm8tQs35-ZGf7a7a2pvFlSduH3mzvMgQaf-06Jjaow/edit#slide=id.g623e4b6d0b_0_32">1</a>.
In other words, a new authentication specification that supports account-less authentication
using lightning invoices and payments.</p>

<a href="#installation" id="installation" style="color: inherit; text-decoration: none;">
  <h2>Installation</h2>
</a>
<p>First install as a module using npm or yarn into your package:</p>
<pre><code class="language-bash"><span class="hl-0">$&gt; npm --save install lsat-js</span><br/><span class="hl-1"># or</span><br/><span class="hl-0">$&gt; yarn add lsat-js</span>
</code></pre>

<a href="#usage" id="usage" style="color: inherit; text-decoration: none;">
  <h2>Usage</h2>
</a>
<p><code>lsat-js</code> is not a stand-alone server or client and so it can&#39;t issue or generate Lsats on its own. It simply
offers utlities for working with Lsats including:</p>
<ul>
<li>Serialization and deserialization</li>
<li>Validation</li>
<li>Working with caveats (restrictions placed on the LSAT&#39;s macaroon)</li>
</ul>
<p>To test with an actual server that issues LSATs, check out <a href="https://github.com/Tierion/boltwall">boltwall</a>.
The below example assumes a running boltwall (or compatible) server on your local machine.
The same utilities can be used against raw LSATs as well.</p>
<pre><code class="language-js"><span class="hl-2">import</span><span class="hl-0"> { </span><span class="hl-3">Lsat</span><span class="hl-0"> } </span><span class="hl-2">from</span><span class="hl-0"> </span><span class="hl-4">&#39;lsat-js&#39;</span><br/><span class="hl-2">import</span><span class="hl-0"> </span><span class="hl-3">fetch</span><span class="hl-0"> </span><span class="hl-2">from</span><span class="hl-0"> </span><span class="hl-4">&#39;node-fetch&#39;</span><br/><br/><span class="hl-1">// fetching a protected route which will return a 402 response and LSAT challenge</span><br/><span class="hl-5">fetch</span><span class="hl-0">(</span><span class="hl-4">&#39;http://localhost:5000/protected&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">  .</span><span class="hl-5">then</span><span class="hl-0">(</span><span class="hl-3">resp</span><span class="hl-0"> </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-7">header</span><span class="hl-0"> = </span><span class="hl-3">resp</span><span class="hl-0">.</span><span class="hl-3">headers</span><span class="hl-0">.</span><span class="hl-5">get</span><span class="hl-0">(</span><span class="hl-4">&#39;www-authenticate&#39;</span><span class="hl-0">)</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-7">lsat</span><span class="hl-0"> = </span><span class="hl-3">Lsat</span><span class="hl-0">.</span><span class="hl-5">fromHeader</span><span class="hl-0">(</span><span class="hl-3">header</span><span class="hl-0">)</span><br/><br/><span class="hl-0">    </span><span class="hl-1">// show some information about the lsat</span><br/><span class="hl-0">    </span><span class="hl-3">console</span><span class="hl-0">.</span><span class="hl-5">log</span><span class="hl-0">(</span><span class="hl-3">lsat</span><span class="hl-0">.</span><span class="hl-3">invoice</span><span class="hl-0">)</span><br/><span class="hl-0">    </span><span class="hl-3">console</span><span class="hl-0">.</span><span class="hl-5">log</span><span class="hl-0">(</span><span class="hl-3">lsat</span><span class="hl-0">.</span><span class="hl-3">baseMacaroon</span><span class="hl-0">)</span><br/><span class="hl-0">    </span><span class="hl-3">console</span><span class="hl-0">.</span><span class="hl-5">log</span><span class="hl-0">(</span><span class="hl-3">lsat</span><span class="hl-0">.</span><span class="hl-3">paymentHash</span><span class="hl-0">)</span><br/><br/><span class="hl-0">    </span><span class="hl-1">// after the invoice is paid, you can add the preimage</span><br/><span class="hl-0">    </span><span class="hl-1">// this is just a stub for getting the preimage string</span><br/><span class="hl-0">    </span><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-7">preimage</span><span class="hl-0"> = </span><span class="hl-5">getPreimage</span><span class="hl-0">()</span><br/><br/><span class="hl-0">    </span><span class="hl-1">// this will validate that the preimage is valid and throw if not</span><br/><span class="hl-0">    </span><span class="hl-3">lsat</span><span class="hl-0">.</span><span class="hl-5">setPreimage</span><span class="hl-0">(</span><span class="hl-3">preimage</span><span class="hl-0">)</span><br/><br/><span class="hl-0">    </span><span class="hl-2">return</span><span class="hl-0"> </span><span class="hl-5">fetch</span><span class="hl-0">(</span><span class="hl-4">&#39;http://localhost:5000/protected&#39;</span><span class="hl-0">, {</span><br/><span class="hl-0">      </span><span class="hl-3">headers:</span><span class="hl-0"> {</span><br/><span class="hl-0">        </span><span class="hl-4">&#39;Authorization&#39;</span><span class="hl-3">:</span><span class="hl-0"> </span><span class="hl-3">lsat</span><span class="hl-0">.</span><span class="hl-5">toToken</span><span class="hl-0">()</span><br/><span class="hl-0">      }</span><br/><span class="hl-0">    })</span><br/><span class="hl-0">  })</span><br/><span class="hl-0">  .</span><span class="hl-5">then</span><span class="hl-0">(</span><span class="hl-3">resp</span><span class="hl-0"> </span><span class="hl-6">=&gt;</span><span class="hl-0"> </span><span class="hl-3">resp</span><span class="hl-0">.</span><span class="hl-5">json</span><span class="hl-0">())</span><br/><span class="hl-0">  .</span><span class="hl-5">then</span><span class="hl-0">(</span><span class="hl-3">json</span><span class="hl-0"> </span><span class="hl-6">=&gt;</span><span class="hl-0"> {</span><br/><span class="hl-0">    </span><span class="hl-3">console</span><span class="hl-0">.</span><span class="hl-5">log</span><span class="hl-0">(</span><span class="hl-4">&#39;With valid LSAT, we should get a response:&#39;</span><span class="hl-0">, </span><span class="hl-3">json</span><span class="hl-0">)</span><br/><span class="hl-0">  })</span><br/><span class="hl-0">  .</span><span class="hl-5">catch</span><span class="hl-0">(</span><span class="hl-3">e</span><span class="hl-0"> </span><span class="hl-6">=&gt;</span><span class="hl-0"> </span><span class="hl-3">console</span><span class="hl-0">.</span><span class="hl-5">error</span><span class="hl-0">(</span><span class="hl-3">e</span><span class="hl-0">))</span>
</code></pre>

<a href="#api" id="api" style="color: inherit; text-decoration: none;">
  <h2>API</h2>
</a>
<p>To view detailed API docs and type information, please see our full
<a href="https://tierion.github.io/lsat-js/">API documentation</a>.</p>
<p><code>lsat-js</code> provides the following utilities for working with LSATs:</p>

<a href="#lsat" id="lsat" style="color: inherit; text-decoration: none;">
  <h4>Lsat</h4>
</a>
<p>A class for serializing and deserializing an LSAT. It supports:</p>
<ul>
<li>Getting an LSAT from a response header</li>
<li>Getting an LSAT the raw challenge (header without the <code>LSAT</code> type prefix)</li>
<li>Serializing and Deserializing from a &quot;token&quot; (i.e. what the client sends in the <code>Authorization</code> header)</li>
<li>Adding and verifying the preimage (it will throw if the preimage is not properly formatted
or if it does not match the invoice&#39;s payment hash)</li>
<li>Checking if the macaroon is expired</li>
<li>Versioning through the Identifier class (also exposed via <code>lsat-js</code>) to support future updates
to LSAT serialization</li>
<li>Adding new first party caveats</li>
<li>Listing all caveats on an LSAT&#39;s macaroon</li>
</ul>

<a href="#caveat" id="caveat" style="color: inherit; text-decoration: none;">
  <h4>Caveat</h4>
</a>
<p>A caveat is a &quot;condition&quot; that is placed on a macaroon that restricts its use. Using these,
an LSAT can contain additional authorization restrictions besides just payment, e.g. time based or user
based restrictions or authorization levels. This also allows for &quot;attenuation&quot;, i.e. the holder of the
LSAT can lend out the authorization with additional caveats restricting its use.</p>
<p>Creating a caveat is as simple as:</p>
<pre><code class="language-js"><span class="hl-2">import</span><span class="hl-0"> { </span><span class="hl-3">Caveat</span><span class="hl-0"> } </span><span class="hl-2">from</span><span class="hl-0"> </span><span class="hl-4">&#39;lsat-js&#39;</span><br/><br/><span class="hl-6">const</span><span class="hl-0"> </span><span class="hl-7">caveat</span><span class="hl-0"> = </span><span class="hl-6">new</span><span class="hl-0"> </span><span class="hl-5">Caveat</span><span class="hl-0">({</span><br/><span class="hl-0">  </span><span class="hl-3">condition:</span><span class="hl-0"> </span><span class="hl-4">&#39;expiration&#39;</span><span class="hl-0">,</span><br/><span class="hl-0">  </span><span class="hl-3">value:</span><span class="hl-0"> </span><span class="hl-8">Date</span><span class="hl-0">.</span><span class="hl-5">now</span><span class="hl-0">() + </span><span class="hl-9">10000</span><span class="hl-0">, </span><span class="hl-1">// expires in 10 seconds</span><br/><span class="hl-0">  </span><span class="hl-3">comp:</span><span class="hl-0"> </span><span class="hl-4">&#39;=&#39;</span><span class="hl-0">, </span><span class="hl-1">// this is the default value, also supports &quot;&lt;&quot; and &quot;&gt;&quot;</span><br/><span class="hl-0">})</span><br/><span class="hl-3">console</span><span class="hl-0">.</span><span class="hl-5">log</span><span class="hl-0">(</span><span class="hl-3">caveat</span><span class="hl-0">.</span><span class="hl-5">encode</span><span class="hl-0">()) </span><span class="hl-1">// returns `expiration=1577228778197`</span><br/><span class="hl-3">console</span><span class="hl-0">.</span><span class="hl-5">log</span><span class="hl-0">(</span><span class="hl-3">Caveat</span><span class="hl-0">.</span><span class="hl-5">decode</span><span class="hl-0">(</span><span class="hl-3">caveat</span><span class="hl-0">.</span><span class="hl-5">encode</span><span class="hl-0">())) </span><span class="hl-1">// creates new caveat w/ same properties</span>
</code></pre>
<p>To add the caveat to a macaroon you&#39;ll need to use a compatible macaroon library
such as <a href="https://github.com/nitram509/macaroons.js">macaroon.js</a>, or add it to an LSAT&#39;s
macaroon with the <code>addFirstPartyCaveat</code> method available on the <code>Lsat</code> object.</p>

<a href="#hascaveat" id="hascaveat" style="color: inherit; text-decoration: none;">
  <h4><code>hasCaveat</code></h4>
</a>
<p>A function that takes a raw macaroon and a caveat and returns true or false depending on if
the macaroon contains that caveat.</p>

<a href="#verifycaveats" id="verifycaveats" style="color: inherit; text-decoration: none;">
  <h4><code>verifyCaveats</code></h4>
</a>
<p>Verifies caveats given one or a set of caveats and corresponding &quot;satisfiers&quot; to test the caveats against.
A satisfier is an object with a condition, a <code>satisfyFinal</code> function, and an optional <code>satisfyPrevious</code>
function. <code>satisfyFinal</code> will test only the last caveat on a macaroon of the matching condition
and <code>satisfyPrevious</code> compares each caveat of the same condition against each other. This allows
more flexible attenuation where you can ensure, for example, that every &quot;new&quot; caveat is not less
restrictive than a previously added one. In the case of an expiration, you probably want to have a satisfier
that tests that a newer <code>expiration</code> is sooner than the first <code>expiration</code> added, otherwise, a client could 
add their own expiration further into the future.</p>
<p>The exported <code>Satisfier</code> interface described in the docs provides more details on creating
your own satisfiers</p>

<a href="#verifymacarooncaveats" id="verifymacarooncaveats" style="color: inherit; text-decoration: none;">
  <h4><code>verifyMacaroonCaveats</code></h4>
</a>
<p>This can only be run by the creator of the macaroon since the signing secret is required to
verify the macaroon. This will run all necessary checks (requires satisfiers to be passed
as arguments if there are caveats on the macaroon) and return true if the macaroon is valid
or false otherwise.</p>
</div></div><div class="col-4 col-menu menu-sticky-wrap menu-highlight"><nav class="tsd-navigation primary"><ul><li class="current"><a href="modules.html">Exports</a></li></ul></nav><nav class="tsd-navigation secondary menu-sticky"><ul><li class="tsd-kind-class"><a href="classes/Caveat.html" class="tsd-kind-icon">Caveat</a></li><li class="tsd-kind-class"><a href="classes/ErrInvalidCaveat.html" class="tsd-kind-icon">Err<wbr/>Invalid<wbr/>Caveat</a></li><li class="tsd-kind-class"><a href="classes/ErrUnknownVersion.html" class="tsd-kind-icon">Err<wbr/>Unknown<wbr/>Version</a></li><li class="tsd-kind-class"><a href="classes/Identifier.html" class="tsd-kind-icon">Identifier</a></li><li class="tsd-kind-class"><a href="classes/InvalidCapabilitiesError.html" class="tsd-kind-icon">Invalid<wbr/>Capabilities<wbr/>Error</a></li><li class="tsd-kind-class"><a href="classes/InvalidServicesError.html" class="tsd-kind-icon">Invalid<wbr/>Services<wbr/>Error</a></li><li class="tsd-kind-class"><a href="classes/Lsat.html" class="tsd-kind-icon">Lsat</a></li><li class="tsd-kind-class"><a href="classes/NoServicesError.html" class="tsd-kind-icon">No<wbr/>Services<wbr/>Error</a></li><li class="tsd-kind-class"><a href="classes/Service.html" class="tsd-kind-icon">Service</a></li><li class="tsd-kind-interface"><a href="interfaces/CaveatOptions.html" class="tsd-kind-icon">Caveat<wbr/>Options</a></li><li class="tsd-kind-interface"><a href="interfaces/IdentifierOptions.html" class="tsd-kind-icon">Identifier<wbr/>Options</a></li><li class="tsd-kind-interface"><a href="interfaces/LsatOptions.html" class="tsd-kind-icon">Lsat<wbr/>Options</a></li><li class="tsd-kind-interface"><a href="interfaces/MacaroonClass.html" class="tsd-kind-icon">Macaroon<wbr/>Class</a></li><li class="tsd-kind-interface"><a href="interfaces/Satisfier.html" class="tsd-kind-icon">Satisfier</a></li><li class="tsd-kind-interface"><a href="interfaces/ServiceClassOptions.html" class="tsd-kind-icon">Service<wbr/>Class<wbr/>Options</a></li><li class="tsd-kind-type-alias"><a href="modules.html#SatisfyFinal" class="tsd-kind-icon">Satisfy<wbr/>Final</a></li><li class="tsd-kind-type-alias"><a href="modules.html#SatisfyPrevious" class="tsd-kind-icon">Satisfy<wbr/>Previous</a></li><li class="tsd-kind-variable"><a href="modules.html#LATEST_VERSION" class="tsd-kind-icon">LATEST_<wbr/>VERSION</a></li><li class="tsd-kind-variable"><a href="modules.html#SERVICES_CAVEAT_CONDITION" class="tsd-kind-icon">SERVICES_<wbr/>CAVEAT_<wbr/>CONDITION</a></li><li class="tsd-kind-variable"><a href="modules.html#SERVICE_CAPABILITIES_SUFFIX" class="tsd-kind-icon">SERVICE_<wbr/>CAPABILITIES_<wbr/>SUFFIX</a></li><li class="tsd-kind-variable"><a href="modules.html#TOKEN_ID_SIZE" class="tsd-kind-icon">TOKEN_<wbr/>ID_<wbr/>SIZE</a></li><li class="tsd-kind-variable"><a href="modules.html#expirationSatisfier" class="tsd-kind-icon">expiration<wbr/>Satisfier</a></li><li class="tsd-kind-function"><a href="modules.html#createCapabilitiesSatisfier" class="tsd-kind-icon">create<wbr/>Capabilities<wbr/>Satisfier</a></li><li class="tsd-kind-function"><a href="modules.html#createNewCapabilitiesCaveat" class="tsd-kind-icon">create<wbr/>New<wbr/>Capabilities<wbr/>Caveat</a></li><li class="tsd-kind-function"><a href="modules.html#createServicesSatisfier" class="tsd-kind-icon">create<wbr/>Services<wbr/>Satisfier</a></li><li class="tsd-kind-function"><a href="modules.html#decodeCapabilitiesValue" class="tsd-kind-icon">decode<wbr/>Capabilities<wbr/>Value</a></li><li class="tsd-kind-function"><a href="modules.html#decodeServicesCaveat" class="tsd-kind-icon">decode<wbr/>Services<wbr/>Caveat</a></li><li class="tsd-kind-function"><a href="modules.html#encodeServicesCaveatValue" class="tsd-kind-icon">encode<wbr/>Services<wbr/>Caveat<wbr/>Value</a></li><li class="tsd-kind-function"><a href="modules.html#getCaveatsFromMacaroon" class="tsd-kind-icon">get<wbr/>Caveats<wbr/>From<wbr/>Macaroon</a></li><li class="tsd-kind-function"><a href="modules.html#getRawMacaroon" class="tsd-kind-icon">get<wbr/>Raw<wbr/>Macaroon</a></li><li class="tsd-kind-function"><a href="modules.html#hasCaveat" class="tsd-kind-icon">has<wbr/>Caveat</a></li><li class="tsd-kind-function"><a href="modules.html#parseChallengePart" class="tsd-kind-icon">parse<wbr/>Challenge<wbr/>Part</a></li><li class="tsd-kind-function"><a href="modules.html#verifyCaveats" class="tsd-kind-icon">verify<wbr/>Caveats</a></li><li class="tsd-kind-function"><a href="modules.html#verifyMacaroonCaveats" class="tsd-kind-icon">verify<wbr/>Macaroon<wbr/>Caveats</a></li></ul></nav></div></div></div><footer class="with-border-bottom"><div class="container"><h2>Legend</h2><div class="tsd-legend-group"><ul class="tsd-legend"><li class="tsd-kind-constructor tsd-parent-kind-class"><span class="tsd-kind-icon">Constructor</span></li><li class="tsd-kind-property tsd-parent-kind-class"><span class="tsd-kind-icon">Property</span></li><li class="tsd-kind-method tsd-parent-kind-class"><span class="tsd-kind-icon">Method</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-property tsd-parent-kind-interface"><span class="tsd-kind-icon">Property</span></li><li class="tsd-kind-method tsd-parent-kind-interface"><span class="tsd-kind-icon">Method</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-property tsd-parent-kind-class tsd-is-static"><span class="tsd-kind-icon">Static property</span></li><li class="tsd-kind-method tsd-parent-kind-class tsd-is-static"><span class="tsd-kind-icon">Static method</span></li></ul></div><h2>Settings</h2><p>Theme <select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></p></div></footer><div class="container tsd-generator"><p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div><div class="overlay"></div><script src="assets/main.js"></script></body></html>